# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x
    - name: Restore dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build --no-restore
    - name: Test
      run: dotnet test --no-build --verbosity normal

    # containerization steps
    - name: Build Docker image
      run: |
        docker build -t bethanyspieshop:latest .
    - name: Save Docker image to artifact
      run: |
        docker save bethanyspieshop:latest -o image.tar
    - uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: image.tar

    # deploy to remote server over SSH
    # the workflow uses a **private key** stored in the SSH_PRIVATE_KEY secret
    # (PEM format). the **public key** corresponding to that private key must
    # already be present in the remote host's ~/.ssh/authorized_keys file.
    # we don't copy the private key to the server â€“ the runner uses it locally
    # to authenticate when calling `ssh` / `scp`.
    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
    - name: Copy image to target host    - name: Copy image to target host
      run: |
        ssh -vvv -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} exit
      run: |
        scp -o StrictHostKeyChecking=no image.tar \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/image.tar
    - name: Load image and run container on host
      run: |
        ssh -o StrictHostKeyChecking=no \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} <<'EOF'
          docker load < /tmp/image.tar
          docker rm -f bethanyspieshop_mirtha || true
          docker run -d --name bethanyspieshop_mirtha -p 8500:5010 bethanyspieshop:latest
        EOF
